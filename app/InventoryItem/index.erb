<%= render partial: 'partials/page_header',
           locals: {
               :title => 'Inventory Items',
               :main_menu => [
                   {:type => :action, :action => url_for(:controller => :Settings, :action => :do_sync), :role => 'sync', :title => 'Sync'},
                   {:type => :action, :action => url_for(:controller => :Settings, :action => :index), :title => 'Settings'},
                   {:type => :action, :action => url_for(:controller => :Settings, :action => :logout), :title => 'Log Out'},
                   {:type => :action, :action => url_for(:controller => :Settings, :action => :do_quit), :title => 'Quit'}
               ],
               :context_menu => [
                   {:type => :form, :id => 'search', :input => {:type => 'search', :placeholder => 'Search', :classes => ''}}
               ]} %>

<div class="page">

  <% if scanner_camera? %>
      <div class="btn-scan-wrapper">
        <button class="btn btn-primary btn-lg btn-block" data-action="scan">Press to scan</button>
      </div>
  <% end %>

  <div id="item-list">
    <% if @inventoryItems.size != 0 %>
        <div class="list-group">
          <%= render partial: 'inventory_item', collection: @inventoryItems %>
        </div>
    <% else %>
        <div class="alert alert-warning" role="alert"><h4>Items not found</h4></div>
    <% end %>
  </div>

</div>

<script>
    (function () {
        var timeoutId;
        var timeout = 500;

        var serverRequest = function (query) {
            $.ajax({
                type: "post",
                dataType: "html",
                url: "<%= url_for :action => :do_search %>",
                cache: false,
                data: {query: query}
            })
                .done(function (html) {
                    $("#item-list").html(html);
                });
        };

        $("#search").bind("input", function (anEvent) {
            if (timeoutId != null) {
                clearTimeout(timeoutId);
            }
            timeoutId = setTimeout(function () {
                serverRequest($(anEvent.target).val());
            }, timeout);
        });

        $("#clear").on("click", function () {
            $("#search").val("");
            serverRequest("");
        });
    })();
</script>

<script>
    var spinner;

    $(".page").on("spinnerOn", function (event) {
        spinner = new Spinner().spin();
        $(".page").append(spinner.el);
    });

    $(".page").on("spinnerOff", function (event) {
        spinner.stop();
    });

    $("[data-action=scan]").on("click", function (event) {
        $(".alert").addClass("hidden");
        $.post("<%= url_for(:action => :scan_by_camera) %>");
    });

    $(".context-menu-btn").on("click", function () {
        $("#main-menu").collapse("hide")
    });
    $(".main-menu-btn").on("click", function () {
        $("#context-menu").collapse("hide")
    });

    $("#context-menu form#search").on("submit", function () {
        var query = $("#context-menu form#search input[type=search]").val();
        $.ajax({
            type: "post",
            dataType: "html",
            url: "<%= url_for :action => :do_search %>",
            cache: false,
            data: {query: query}
        })
            .done(function (html) {
                $("#item-list").html(html);
            });

    });

    $("a[data-role=sync]").on("click", function(event){
        event.preventDefault();
        $("#main-menu").collapse("hide");
        $.post("<%= url_for(:controller => :Settings, :action => :execute_sync) %>");
    })


</script>
